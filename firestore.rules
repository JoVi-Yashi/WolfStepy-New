/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model. All data is segregated by user and is considered private. A user can only access and manage their own data.
 *
 * Data Structure: All application data is stored hierarchically under the `/users/{userId}` path. A user's profile is the root document, and all related data, such as sessions, categories, and products, are stored in subcollections beneath it. This structure provides inherent security boundaries.
 *
 * Key Security Decisions:
 * - User Isolation: A user's access is strictly confined to their own document tree (e.g., `/users/{their-own-userId}/...`). They cannot read or write to another user's data.
 * - No User Listing: It is not possible for any client to list all documents in the top-level `/users` collection, protecting user privacy.
 * - Self-Creation: A newly authenticated user is permitted to create their own user profile document, but no one else's.
 * - Relational Integrity: On creation and update, rules validate that key identifiers (like `user.id` or `product.userId`) are correctly set and immutable, ensuring the integrity of the data model.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    function hasValidId(userId) {
      return request.resource.data.id == userId;
    }
    
    function hasValidUserId(userId) {
      return request.resource.data.userId == userId;
    }
    
    function isIdImmutable() {
      return request.resource.data.id == resource.data.id;
    }

    function isUserIdImmutable() {
      return request.resource.data.userId == resource.data.userId;
    }


    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; 
      allow create: if isOwner(userId) && hasValidId(userId);
      allow update: if isExistingOwner(userId) && isIdImmutable();
      allow delete: if isExistingOwner(userId);

      match /sessions/{sessionId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId) && hasValidUserId(userId);
        allow update: if isExistingOwner(userId) && isUserIdImmutable();
        allow delete: if isExistingOwner(userId);
      }
      
      match /categories/{categoryId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId) && hasValidUserId(userId);
        allow update: if isExistingOwner(userId) && isUserIdImmutable();
        allow delete: if isExistingOwner(userId);
      }
      
      match /products/{productId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId) && hasValidUserId(userId);
        allow update: if isExistingOwner(userId) && isUserIdImmutable();
        allow delete: if isExistingOwner(userId);
      }
    }
  }
}
